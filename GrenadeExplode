local ReplicatedStorage = game:GetService("ReplicatedStorage")
local ServerStorage = game:GetService("ServerStorage")
local Players = game:GetService("Players")
local FastCast = require(ReplicatedStorage:WaitForChild("FastCast"))
local bombThrown = ReplicatedStorage:WaitForChild("AbilityActions"):WaitForChild("GrenadeThrown")
local bombExploded = ReplicatedStorage:WaitForChild("AbilityActions"):WaitForChild("GrenadeExploded")
local CreateLocalCosmeticProjectile = ReplicatedStorage:WaitForChild("AbilityActions"):WaitForChild("CreateLocalCosmeticProjectile")
local explodeSound = script:WaitForChild("ExplosionSound")
local bombTemplate = ReplicatedStorage:WaitForChild("AbilityParts"):WaitForChild("DefaultGrenadeMesh"):Clone()
local debris = game:GetService("Debris")
local grenadeClientExplosionPosition = ReplicatedStorage.AbilityActions:WaitForChild("GrenadeClientExplosionPosition")
local ServerScriptService = game:GetService("ServerScriptService")
local RunService = game:GetService("RunService")
bombTemplate.Parent = workspace

--local PlayerWhoFiredProjectile

local caster = FastCast.new()

-- Set up FastCast behavior
local behavior = FastCast.newBehavior()
local params = RaycastParams.new()
params.FilterType = Enum.RaycastFilterType.Exclude
params.FilterDescendantsInstances = {}

bombTemplate.Transparency = 0

behavior.RaycastParams = params
behavior.AutoIgnoreContainer = true
behavior.Acceleration = Vector3.new(0, -workspace.Gravity, 0) -- Simulate gravity
behavior.CosmeticBulletTemplate = bombTemplate
behavior.CosmeticBulletContainer = workspace.BulletFolder
behavior.HighFidelityBehavior = FastCast.HighFidelityBehavior.Always -- Ensure smooth projectile motion

local DamageHandler = require(ServerScriptService:WaitForChild("DamageDealer")) -- adjust path if needed

-- Store already damaged humanoids to prevent duplicate damage

local bulletobj


local function explode(attackerPlayer, position)
	task.spawn(function()
		local alreadyDamaged = {}

		-- Create grenade impact visuals
		local grenadeImpactArea = game.ServerStorage.AbilityParts.GrenadeImpactArea:Clone()
		grenadeImpactArea.CanCollide = false
		grenadeImpactArea.CanQuery = false
		grenadeImpactArea.CanTouch = true
		grenadeImpactArea.Position = position
		grenadeImpactArea.Anchored = true
		grenadeImpactArea.Parent = workspace

		-- Create sound part separately
		local soundPart = Instance.new("Part")
		soundPart.Name = "GrenadeSoundPart"
		soundPart.Anchored = true
		soundPart.CanCollide = false
		soundPart.CanQuery = false
		soundPart.CanTouch = false
		soundPart.Transparency = 1
		soundPart.Position = position
		soundPart.Parent = workspace

		local strikeSoundClone = explodeSound:Clone()
		strikeSoundClone.Parent = soundPart
		strikeSoundClone:Play()

		-- Give the game a chance to render the explosion part
		task.delay(0.05, function()
			local emitters = {
				grenadeImpactArea:FindFirstChild("Attachment"):FindFirstChild("Rings"),
				grenadeImpactArea:FindFirstChild("Attachment"):FindFirstChild("RotatingDebris"),
				grenadeImpactArea:FindFirstChild("Attachment"):FindFirstChild("SmokeBlack"),
				grenadeImpactArea:FindFirstChild("Attachment"):FindFirstChild("SmokeWhite"),
				grenadeImpactArea:FindFirstChild("Attachment"):FindFirstChild("Sparks"),
				grenadeImpactArea:FindFirstChild("Attachment"):FindFirstChild("Debris"),
			}

			local emitCounts = {5, 5, 5, 5, 22, 12}

			for i, emitter in ipairs(emitters) do
				if emitter and emitter:IsA("ParticleEmitter") then
					emitter:Emit(emitCounts[i])
				end
			end	
		end)

		local radius = grenadeImpactArea.Size.X / 2
		local regionParts = workspace:GetPartBoundsInBox(grenadeImpactArea.CFrame, grenadeImpactArea.Size)

		for _, part in ipairs(regionParts) do
			local humanoid = part.Parent:FindFirstChildOfClass("Humanoid")
			if not humanoid then
				local model = part:FindFirstAncestorOfClass("Model")
				if model then
					humanoid = model:FindFirstChildOfClass("Humanoid")
				end
			end

			if humanoid and not alreadyDamaged[humanoid] and humanoid.Health > 0 then
				local char = humanoid.Parent
				local root = char:FindFirstChild("HumanoidRootPart")
				if root then
					--  Line-of-sight check
					local rayParams = RaycastParams.new()
					rayParams.FilterType = Enum.RaycastFilterType.Exclude
					rayParams.FilterDescendantsInstances = {grenadeImpactArea, char}

					local rayResult = workspace:Raycast(position, (root.Position - position), rayParams)

					if rayResult == nil or rayResult.Instance:IsDescendantOf(char) then
						-- means no wall in between
						local isBot = (char.Name == "Range Bot") or string.match(char.Name, "[BOT]")
						local victimPlayer = Players:GetPlayerFromCharacter(char)

						local isEnemy = false
						if victimPlayer and attackerPlayer and victimPlayer:FindFirstChild("GameTeam") and attackerPlayer:FindFirstChild("GameTeam") then
							isEnemy = victimPlayer.GameTeam.playerTeam.Value ~= attackerPlayer.GameTeam.playerTeam.Value
						end

						if isEnemy or isBot then
							alreadyDamaged[humanoid] = true

							-- Apply damage
							DamageHandler.handleDamage(
								attackerPlayer,
								root,
								"Grenade",
								125,
								125,
								false,
								0,
								0,
								0,
								0
							)
						end
					end
				end
			end
		end

		-- Clean up
		debris:AddItem(grenadeImpactArea, 2)
		debris:AddItem(soundPart, 2)
		--PlayerWhoFiredProjectile = nil
	end)

end

bombThrown.OnServerEvent:Connect(function(player, targetPosition, toolPos, tool)
	bombThrown:FireClient(player)

	local direction = (targetPosition - toolPos).unit 
	local initialVelocity = 150 

	local grenade = ReplicatedStorage:WaitForChild("AbilityParts"):WaitForChild("DefaultGrenadeMesh"):Clone()
	grenade.Parent = workspace
	grenade:SetNetworkOwner(player)
	grenade.CFrame = CFrame.new(toolPos) 
	
	--local bv = Instance.new("BodyVelocity")
	--bv.Velocity = targetPosition * initialVelocity
	--bv.Parent = grenade
	grenade.AssemblyLinearVelocity = direction * initialVelocity
	
	task.delay(1.5, function()
		explode(grenade:GetNetworkOwner(), grenade.Position)
		grenade:Destroy()
	end)	


end)
